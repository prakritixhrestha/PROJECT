{% extends 'custom_admin/base_admin_custom.html' %}
{% load static %}

{% block title %}Dashboard Overview{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .kpi-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 35px; }
    
    .kpi-card { 
        background: white; 
        padding: 25px; 
        border-radius: 12px; 
        box-shadow: 0 4px 15px rgba(75, 46, 30, 0.04);
        position: relative;
        overflow: hidden;
    }
    
    .kpi-icon {
        width: 42px;
        height: 42px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        margin-bottom: 20px;
    }
    
    .kpi-card.revenue { border-bottom: 4px solid #2ecc71; }
    .kpi-card.orders { border-bottom: 4px solid #3498db; }
    .kpi-card.products { border-bottom: 4px solid #f39c12; }
    .kpi-card.users { border-bottom: 4px solid #9b59b6; }

    .kpi-card .label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; margin-bottom: 8px; }
    .kpi-card .value { font-size: 24px; font-weight: 800; color: var(--text-main); }
    .kpi-card .meta { font-size: 11px; margin-top: 10px; font-weight: 600; display: flex; align-items: center; gap: 5px; }

    .charts-row { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 35px; }
    .chart-container { 
        background: white; 
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: 0 4px 15px rgba(75, 46, 30, 0.04);
        height: 100%;
    }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .chart-header h3 { font-size: 15px; font-weight: 700; color: var(--text-main); }
    
    .recent-table-card { 
        background: white; 
        padding: 30px; 
        border-radius: 16px; 
        box-shadow: 0 4px 15px rgba(75, 46, 30, 0.04);
    }

    /* STATUS BADGES */
    .status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
    }
    .status-delivered { background: #e8f5e9; color: #2e7d32; }
    .status-pending { background: #fff8e1; color: #f57f17; }
    .status-other { background: #f1f3f4; color: #5f6368; }

    @keyframes slideUp { 
        from { transform: translateY(20px); opacity:0; } 
        to { transform: translateY(0); opacity:1; } 
    }
</style>
{% endblock %}

{% block content %}
<h2 style="font-size: 24px; font-weight: 700; margin-bottom: 30px;">Dashboard Overview</h2>

<!-- KPI ROW -->
<div class="kpi-row">
    <!-- Revenue -->
    <div class="kpi-card revenue">
        <div class="kpi-icon" style="background: #e9f7ef; color: #2ecc71; font-weight: 800; font-size: 14px; font-family: 'DM Sans', sans-serif;">Rs</div>
        <div class="label">Total Revenue</div>
        <div class="value">Rs {{ total_revenue|floatformat:0 }}</div>
        <div class="meta" style="color: #2ecc71;"><i class="fas fa-arrow-up"></i> +12% growth</div>
    </div>

    <!-- Orders -->
    <div class="kpi-card orders">
        <div class="kpi-icon" style="background: #eaf2f8; color: #3498db;"><i class="fas fa-shopping-cart"></i></div>
        <div class="label">Total Orders</div>
        <div class="value">{{ total_orders }}</div>
        <div class="meta" style="color: #3498db;"><i class="fas fa-plus-circle"></i> New orders</div>
    </div>

    <!-- Products -->
    <div class="kpi-card products">
        <div class="kpi-icon" style="background: #fdf5e6; color: #f39c12;"><i class="fas fa-couch"></i></div>
        <div class="label">Products</div>
        <div class="value">{{ total_products }}</div>
        <div class="meta" style="color: var(--text-muted);">Active Items</div>
    </div>

    <!-- Customers -->
    <div class="kpi-card users" style="border-bottom-color: #9b59b6;">
        <div class="kpi-icon" style="background: #f4ecf7; color: #9b59b6;"><i class="fas fa-users"></i></div>
        <div class="label">Customers</div>
        <div class="value">{{ total_users }}</div>
        <div class="meta" style="color: var(--text-muted);">Registered</div>
    </div>

    <!-- Pending Payments -->
    <div class="kpi-card" style="border-bottom: 4px solid #e74c3c;">
        <div class="kpi-icon" style="background: #fdeded; color: #e74c3c;"><i class="fas fa-hand-holding-usd"></i></div>
        <div class="label">Pending Payments</div>
        <div class="value">{{ pending_payments }}</div>
        <div class="meta" style="color: #e74c3c;"><i class="fas fa-clock"></i> Awaiting Action</div>
    </div>
</div>


<!-- CHARTS ROW -->
<div class="charts-row">
    <!-- Revenue Analytics -->
    <div class="chart-container">
        <div class="chart-header">
            <h3>Revenue Analytics</h3>
            <button onclick="openRevenueReport()" style="background: #f8f9fa; border: 1px solid #eee; padding: 6px 12px; border-radius: 8px; font-size: 11px; color: var(--text-muted); cursor: pointer; transition: all 0.2s;">View Report</button>
        </div>
        <div style="height: 300px;">
            <canvas id="revenueChart"></canvas>
        </div>
    </div>

    <!-- Order Activity -->
    <div class="chart-container">
        <div class="chart-header">
            <h3>Order Activity</h3>
        </div>
        <div style="height: 250px; position: relative;">
            <canvas id="activityChart"></canvas>
            <div style="position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div style="font-size: 26px; font-weight: 800; color: var(--text-main);">{{ success_rate }}%</div>
                <div style="font-size: 11px; color: var(--text-muted); font-weight: 700;">Success</div>
            </div>
        </div>
        <div style="margin-top: 30px; display: flex; justify-content: center; gap: 15px; font-size: 10px; font-weight: 800; text-transform: uppercase;">
            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; border-radius: 50%; background: #3498db;"></span> Completed</div>
            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; border-radius: 50%; background: #f1c40f;"></span> Pending</div>
            <div style="display: flex; align-items: center; gap: 5px;"><span style="width: 8px; height: 8px; border-radius: 50%; background: #e74c3c;"></span> Cancelled</div>
        </div>
    </div>
</div>

<!-- RECENT ORDERS -->
<div class="recent-table-card">
    <div style="font-weight: 700; margin-bottom: 25px; font-size: 16px;">Recent Orders</div>
    <table>
        <thead>
            <tr>
                <th>ORDER ID</th>
                <th>CUSTOMER</th>
                <th>DATE</th>
                <th>STATUS</th>
                <th style="text-align: right;">AMOUNT</th>
            </tr>
        </thead>
        <tbody>
            {% for order in recent_orders %}
            <tr>
                <td style="font-weight: 700; color: var(--text-main);">#{{ order.tracking_number|slice:":8"|upper }}</td>
                <td>
                    <div style="font-weight: 700; color: var(--text-main);">{{ order.customer.get_full_name|default:order.customer.username }}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">{{ order.customer.email }}</div>
                </td>
                <td style="color: var(--text-muted);">{{ order.order_date|date:"M d, Y" }}</td>
                <td>
                    <span class="status-badge {% if order.status == 'Delivered' %}status-delivered{% elif order.status == 'Pending' %}status-pending{% else %}status-other{% endif %}">
                        {{ order.status }}
                    </span>
                </td>
                <td style="text-align: right; font-weight: 800; color: var(--text-main);">Rs {{ order.total_price }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{{ chart_labels|json_script:"chart-labels-data" }}
{{ chart_sales|json_script:"chart-sales-data" }}
{{ completed_count|json_script:"completed-count-data" }}
{{ pending_count|json_script:"pending-count-data" }}
{{ cancelled_count|json_script:"cancelled-count-data" }}

<script>
    // Data passed safely from Django
    const chartLabels = JSON.parse(document.getElementById('chart-labels-data').textContent);
    const chartSales = JSON.parse(document.getElementById('chart-sales-data').textContent);
    const completedCount = JSON.parse(document.getElementById('completed-count-data').textContent);
    const pendingCount = JSON.parse(document.getElementById('pending-count-data').textContent);
    const cancelledCount = JSON.parse(document.getElementById('cancelled-count-data').textContent);

    // Chart.js Configuration
    const ctxRev = document.getElementById('revenueChart').getContext('2d');
    
    // Revenue Line Chart
    new Chart(ctxRev, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Revenue',
                data: chartSales,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.05)',
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointRadius: 0,
                pointHoverRadius: 5
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                y: { grid: { borderDash: [5, 5], color: '#f5f5f5' }, ticks: { font: { size: 10 } }, border: { display: false } },
                x: { grid: { display: false }, ticks: { font: { size: 10 } } }
            }
        }
    });

    // Activity Doughnut
    const ctxAct = document.getElementById('activityChart').getContext('2d');
    new Chart(ctxAct, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'Pending', 'Cancelled'],
            datasets: [{
                data: [completedCount, pendingCount, cancelledCount], 
                backgroundColor: ['#3498db', '#f1c40f', '#e74c3c'],
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            cutout: '80%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
        }
    });

    // REVENUE REPORT LOGIC
    function openRevenueReport() {
        const labels = chartLabels;
        const values = chartSales;
        const total = values.reduce((a, b) => a + b, 0);
        
        let tableRows = '';
        for (let i = 0; i < labels.length; i++) {
            tableRows += '<tr>' +
                '<td style="padding:12px 15px; font-size:13px; border-bottom:1px solid #fcfcfc;">' + labels[i] + '</td>' +
                '<td style="padding:12px 15px; font-size:13px; text-align:right; font-weight:700; border-bottom:1px solid #fcfcfc; color:#2ecc71;">Rs ' + values[i].toLocaleString() + '</td>' +
            '</tr>';
        }

        const reportHtml = 
            '<div id="reportModal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; display:flex; align-items:center; justify-content:center; backdrop-filter: blur(4px);">' +
                '<div style="background:white; width:450px; border-radius:16px; padding:35px; box-shadow:0 20px 50px rgba(0,0,0,0.2); animation: slideUp 0.3s ease-out;">' +
                    '<button onclick="document.getElementById(\'reportModal\').remove()" style="float:right; border:none; background:none; font-size:20px; cursor:pointer; color:#888;">&times;</button>' +
                    '<h2 style="font-family:\'DM Sans\', sans-serif; font-weight:800; font-size:20px; margin-bottom:10px; color:var(--text-main);">Overall Revenue Report</h2>' +
                    '<p style="font-size:12px; color:var(--text-muted); margin-bottom:25px;">Detailed breakdown of recent storefront performance.</p>' +
                    '<div style="max-height:300px; overflow-y:auto; border-radius:10px; border:1px solid #f0f0f0;">' +
                        '<table style="width:100%; border-collapse:collapse;">' +
                            '<thead style="position:sticky; top:0; background:#f8f9fa;">' +
                                '<tr>' +
                                    '<th style="padding:12px 15px; font-size:10px; text-transform:uppercase; text-align:left;">Timeline</th>' +
                                    '<th style="padding:12px 15px; font-size:10px; text-transform:uppercase; text-align:right;">Earnings</th>' +
                                '</tr>' +
                            '</thead>' +
                            '<tbody>' + tableRows + '</tbody>' +
                        '</table>' +
                    '</div>' +
                    '<div style="margin-top:25px; padding-top:20px; border-top:2px solid var(--accent-secondary); display:flex; justify-content:space-between; align-items:center;">' +
                        '<span style="font-size:14px; font-weight:800; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted);">Total Revenue sum</span>' +
                        '<span style="font-size:18px; font-weight:900; color:var(--text-main);">Rs ' + total.toLocaleString() + '</span>' +
                    '</div>' +
                '</div>' +
            '</div>';
        
        document.body.insertAdjacentHTML('beforeend', reportHtml);
    }
</script>
{% endblock %}
